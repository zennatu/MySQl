# 初始操作

## 进入数据库

```mysql
"mysql.exe" -u root -p
```

然后输入密码

## 查看所有数据库

```mysql
show databases;
```

## 创建数据库

一般创建

```mysql
create database 数据库名;
```

指定编码创建（以utf-8为例）

```mysql
create database 数据库名 default CHARACTER set utf8 collate utf8_general_ci;
```

## 进入数据库

```mysql
use 数据库名;
```

## 删除数据库

```mysql
drop database 数据库名;
```

## 注意

所有指令都得后加封号

# 数据表操作

## 进入数据库

```mysql
use 数据库名;
show tables;
```

## 创建表结构

~~~mysql
create table 表名(
	列名	类型,
	列名	类型,
    列名	类型
)default charset=utf8;
~~~

```mysql
create table 表名(
	id	int primary key,				-- 主键（不允许为空，不能重复）
	name	varchar(16)	not null,		-- 不允许为空
    email	varchar(32)	null,			-- 允许为空
    age 	int default	3				-- 插入数据时，如果不给age列设置值，默认值3
)default charset=utf8;
```

主键一般用于ID编号，常将其与自增结合

```mysql
create table 表名(
	id	int not null auto_increment primary key,				-- 不允许为空，主键，自增
)default charset=utf8;
```

一个表只能有一个自增列，其通常为主键

## 删除表

```mysql
drop table 表名;
```

## 清空表

```mysql
delete from 表名;
truncate table 表名;			速度更快，无法撤销
```

## 修改表

### 添加列

```mysql
alter table 表名 add 列名 类型;
alter table 表名 add 列名 类型 default 默认值;
alter table 表名 add 列名 类型 not null default 默认值;
alter table 表名 add 列名 类型 not null primary key auto_increment;
```

### 删除列

```mysql
alter table 表名 drop column 列名;
```

### 修改列 类型

```mysql
alter table 表名 modify column 列名 类型;
```

### 修改列 类型+名称

```mysql
alter table 表名 change 原列名 新列名 新类型;
```

```mysql
alter table tb change id id int not null;
alter table tb change id id int not null default 5;
alter table tb change id id int not null primary key auto_increment;
```

在执行上述操作后又执行

```mysql
alter table tb change id id;
```

意为删除之前所加限制（现在可以为空、不为主键，不自增）

### 修改列 默认值

```mysql
alter table 表名 alter 列名 set default 10000;
```

### 删除列 默认值

```mysql
alter table 表名 alter 列名 drop default;
```

### 添加主键

```mysql
alter table 表名 add primary key(列名);
```

### 删除主键

```mysql
alter table 表名 drop primary key;
```

## 内置客户端操作

### 数据插入

```mysql
insert into 表名(键1,键2,键3) value(数值1,数值2,数值3);
insert into 表名(键1,键2,键3) value(数值1,数值2,数值3),value(数值4,数值5,数值6);
insert into 表名 alue(数值1,数值2,数值3),value(数值4,数值5,数值6); 当表中只有三列数据时
```

### 数值查看

```mysql
select * from 表名;
select 列名,列名,列名 from 表名;
select 列名,列名 as 别名,列名 from 表名;
select * from 表名 where 条件;
```

### 数据删除

```mysql
delete from 表名;
delete from 表名 where 条件;
```

```mysql
delete from tb where name="1";
delete from tb where name="1" and password ="123";
delete from tb where name="1" and id>9;
```

### 修改数据

```mysql
update 表名 set 列名=值;
update 表名 set 列名=值 where 条件;
```

```mysql
update tb set name="1";
update tb set name="1" where id=1;
update tb set age=age+1 where id=2;
update users set name=concat(name,"123") where id=2;
```



## 数据类型

### 正数

int, 

int unsigned, 

int(m)zerofill,

bigint[(m)] [unsigned] [zerofill]

tinyint[(m)] [unsigned] [zerofill]

### 小数

decimal[(m[,d])] [unsigned] [zerofill]

### 定长字符串

char

### 变长字符串

varchar

### 日期

datetime(推荐)

date

### 时间

timestamp(推荐)

time

## 示例1

```mysql
create database usersdb default charset utf8 collate utf8_general_ci;
```

```mysql
 create table users(
    -> id int not null primary key auto_increment,
    -> name varchar(32),
    -> password varchar(64)
    -> )default charset=utf8;
```

其余操作见		python对MySQL的操作.py

# SQL常用

建如下表

<table>
    <tr>
	    <th colspan="2">depart</th>
	</tr >
    <tr>
    	<td>id</td>
        <td>title</td>
    </tr>
    <tr>
    	<td>1</td>
        <td>开发</td>
    </tr>
    <tr>
    	<td>2</td>
        <td>运营</td>
    </tr>
    <tr>
    	<td>3</td>
        <td>销售</td>
    </tr>
</table>

<table>
    <tr>
	    <th colspan="2">info</th>
	</tr >
    <tr>
    	<td>id</td>
        <td>name</td>
        <td>email</td>
        <td>age</td>
        <td>depart_id</td>
    </tr>
    <tr>
    	<td>1</td>
        <td>user1</td>
        <td>user1@l63.com</td>
        <td>7</td>
        <td>1</td>
    </tr>
    <tr>
    	<td>2</td>
        <td>user2</td>
        <td>user2@l63.com</td>
        <td>6</td>
        <td>1</td>
    </tr>
    <tr>
    	<td>3</td>
        <td>user3</td>
        <td>user3@l63.com</td>
        <td>5</td>
        <td>2</td>
    </tr>
    <tr>
    	<td>4</td>
        <td>user4</td>
        <td>user4@l63.com</td>
        <td>4</td>
        <td>1</td>
    </tr>
    <tr>
    	<td>5</td>
        <td>user5</td>
        <td>user5@l63.com</td>
        <td>3</td>
        <td>3</td>
    </tr>
    <tr>
    	<td>6</td>
        <td>user6</td>
        <td>user6@l63.com</td>
        <td>2</td>
        <td>1</td>
    </tr>
    <tr>
    	<td>7</td>
        <td>user7</td>
        <td>user7@l63.com</td>
        <td>1</td>
        <td>1</td>
    </tr>
</table>

```mysql
create database usersdb default charset utf8 collate utf8_general_ci;
```

```mysql
create table depart(
	id int not null auto_increment primary key,
    title varchar(16) not null
)default charset=utf8;
```

```mysql
create table info(
	id int not null auto_increment primary key,
    name varchar(16) not null,
    email varchar(32) not null,
    age int,
    depart_id int
)default charset=utf8;
```

```mysql
insert into depart(title) values("开发"),("运营"),("销售");

insert into info(name,email,age,depart_id) values("user1","user1@163.com",7,1);
insert into info(name,email,age,depart_id) values("user2","user2@163.com",6,1);
insert into info(name,email,age,depart_id) values("user3","user3@163.com",5,2);
insert into info(name,email,age,depart_id) values("user4","user4@163.com",4,1);
insert into info(name,email,age,depart_id) values("user5","user5@163.com",3,3);
insert into info(name,email,age,depart_id) values("user6","user6@163.com",2,1);
insert into info(name,email,age,depart_id) values("user7","user7@163.com",1,1);
```

## SQL语句

### 条件

```mysql
 select * from info;
 select * from info where age>2;
 select * from info where id in (1,4,6);
 select * from info where id not in (1,4,6);
 select * from info where id in (select id from depart);
 select * from info where exists (select * from depart where id=5);
 select * from info where not exists (select * from depart where id=5);
 select * from (select * from info where id>5) as T where age>1;
 select * from info,depart where info.id>5;
```

### 通配符

```mysql
select * from info where name like "%user%"		-- %代指多字符
select * from info where name like "_ser1"		-- _代指单字符
```

该方法仅使用与数据量少的搜索

### 映射

```mysql
select * from info;

select id, name from info;
select id, name as NM from info;
select id, name as NM, 123 from info;
select id, name as NM, 123 as phone from info;

select 	id, 
		name as NM, 
		123 as phone,
		(select max(id) from depart) as maxID,
		(select min(id) from depart) as minID
from info;

select 	id, 
		name as NM, 
		(select title from depart where depart.id=info.depart_id) as x1,
		(select title from depart where depart.id=info.id) as x2
from info;		--效率低下
```

```mysql
select 	id,
		name,
		case depart_id when 1 then "部门一" else "其他"	end v1,
		case when age<5 then "young" end v2
from info;
```

### 排序

```mysql
select * from info order by age asc;		-- 顺序
select * from info order by id desc;		-- 倒序
```

### 取部分

```mysql
select * from info limit 5;					-- 取前五
select * from info limit 3 offset 2;		-- 从位置2向后取前（第一位为0）
```

### 分组

```mysql
select depart_id from info group by depart_id;
select depart_id,count(1) from info group by depart_id;
select depart_id,count(id) from info group by depart_id having count(id)>2;
```

### 左右连表

```mysql
主表 left outer join 从表 on 主表.x=从表.y			-- 左外连接
从表 right outer join 主表 on 从表.x=主表.y			-- 右外连接
```

```mysql
select * from info left outer join depart on info.depart_id = depart.id;
select info.id,info.name,info.email,depart.title from info left outer join depart on info.depart_id = depart.id;

select info.id,info.name,info.email,depart.title from info right outer join depart on info.depart_id = depart.id;
```

加入多余信息效果更明显

```mysql
insert into depart(title) values("运维");
```

### 内连表

```mysql
表 inner join 表 on 条件							-- 内连接
```

```mysql
select info.id,info.name,info.email,depart.title from info inner join depart on info.depart_id = depart.id;
```

### 优先级

1. join
2. on
3. where
4. group by
5. having
6. order by
7. limit

```mysql
select age,count(id) from info where id>2 group by age having count(id)>1 order by age asc limit 1;
```

### 联合

```mysql
select id,title from depart
union
select id,name from info;

select id,title from depart
union
select email,name from info;			-- 列数需相同，可以类型不一致
```

```mysql
select id from depart
union
select id from info;					-- 自动去重
```

```mysql
select id from depart
union all
select id from info;					-- 保留所有
```

# 表关系

## 单表

## 一对多

### 外键约束

保证一个列的值必须是其他表中存在的数值

表如果没创建，则

```mysql
create table depart(
	id int not null auto_increment primary key,
    title varchar(16) not null
)default charset=utf8;
```

```mysql
create table info(
	id int not null auto_increment primary key,
    name varchar(16) not null,
    email varchar(32) not null,
    age int,
    depart_id int not null,
    constraint fk_info_depart foreign key info(depart_id) references depart_id;
)default charset=utf8;
```

如果表已经创建好了，额外想要增加外键：

```mysql
alter table info add constraint fk_info_depart foreign key info(depart_id) references depart(id);
```

删除外键：

```mysql
alter table info drop foreign key fk_info_depart;
```

## 多对多

# 授权

## 用户管理

查看所有用户

```mysql
select user,authentication_string,host from mysql.user;
```

权限查询

```mysql
desc mysql.user;
```

创建和删除用户

```mysql
create user '用户名'@'连接者的ip地址' identified by '密码'；
```

```mysql
create user kasper@127.0.0.1 identified by '123456';
drop user kasper@127.0.0.1;

create user kasper@'127.0.0.%' identified by '123456';
drop user kasper@'127.0.0.%';

create user kasper@'%' identified by '123456';
drop user kasper@'%';

create user 'kasper'@'%' identified by '123456';
drop user 'kasper'@'%';
```

修改用户

```mysql
rename user '用户名'@'ip地址' to '新用户名'@'ip地址';
```

```mysql
rename user kasper@127.0.0.1 to heck@localhost;
rename user 'kasper'@127.0.0.1 to 'heck'k@localhost;
```

修改密码

```mysql
set password for '用户名'@'ip地址' = Password('新密码')；
```

```mysql
set password for 'kasper'@'%' =Password('root123456')
```

## 授权管理

授权

```mysql
grant 权限 on 数据库,表 to '用户'@'ip地址'
```

```mysql
grant all privileges on *.* to 'kasper'@'localhost';			-- 授权用户kasper所有数据库所有权限
grant all privileges on usersdb to 'kasper'@'localhost';		-- 授权用户kasper数据库usersdb所有权限
grant all privileges on usersdb to 'kasper'@'%';				-- 授权用户kasper数据库usersdb所有权限
grant all privileges on usersdb.info to 'kasper'@'localhost';	-- 授权用户kasper数据库usersdb中表info所有权限

grant select on usersdb.info to 'kasper'@'localhost';			-- 授权用户kasper数据库usersdb中表info的查看权限
grant select,insert on usersdb.info to 'kasper'@'localhost';	-- 授权用户kasper数据库usersdb中表info的查看及插入权限

flush privileges;			-- 不可或缺
```

权限还有很多，此处不一一列举

查看授权

```mysql
show grants for '用户名'@'ip地址';
```

```mysql
show grants for 'kasper'@'localhost';
show grants for 'kasper'@'%';
```

取消权限

```mysql
revoke 权限 on 数据库,表 from '用户名'@'ip地址';
```

```mysql
revoke all privileges on usersdb.* from 'kasper'@'localhost';
revoke all privileges on usersdb.* from 'kasper'@'%';
```

# SQL强化

<table>
    <tr>
	    <th colspan="2">class</th>
	</tr >
    <tr>
    	<td>cid</td>
        <td>caption</td>
    </tr>
    <tr>
    	<td>1</td>
        <td>三年二班</td>
    </tr>
    <tr>
    	<td>2</td>
        <td>一年三班</td>
    </tr>
    <tr>
    	<td>3</td>
        <td>三年一班</td>
    </tr>
</table>

<table>
    <tr>
	    <th colspan="4">student</th>
	</tr >
    <tr>
    	<td>sid</td>
        <td>sname</td>
        <td>gender</td>
        <td>class_id</td>
    </tr>
    <tr>
    	<td>1</td>
        <td>学生1</td>
        <td>女</td>
        <td>1</td>
    </tr>
    <tr>
    	<td>2</td>
        <td>学生2</td>
        <td>女</td>
        <td>1</td>
    </tr>
    <tr>
    	<td>3</td>
        <td>学生3</td>
        <td>男</td>
        <td>2</td>
    </tr>
</table>

<table>
    <tr>
	    <th colspan="2">teacher</th>
	</tr >
    <tr>
    	<td>tid</td>
        <td>tname</td>
    </tr>
    <tr>
    	<td>1</td>
        <td>教师1</td>
    </tr>
    <tr>
    	<td>2</td>
        <td>教师2</td>
    </tr>
    <tr>
    	<td>3</td>
        <td>教师3</td>
    </tr>
</table>

<table>
    <tr>
	    <th colspan="3">course</th>
	</tr >
    <tr>
    	<td>cid</td>
        <td>cname</td>
        <td>teacher_id</td>
    </tr>
    <tr>
    	<td>1</td>
        <td>生物</td>
        <td>1</td>
    </tr>
    <tr>
    	<td>2</td>
        <td>体育</td>
        <td>1</td>
    </tr>
    <tr>
    	<td>3</td>
        <td>物理</td>
        <td>2</td>
    </tr>
</table>

<table>
    <tr>
	    <th colspan="4">score</th>
	</tr >
    <tr>
    	<td>sid</td>
        <td>student_id</td>
        <td>course_id</td>
        <td>number</td>
    </tr>
    <tr>
    	<td>1</td>
        <td>1</td>
        <td>1</td>
        <td>60</td>
    </tr>
    <tr>
    	<td>2</td>
        <td>1</td>
        <td>2</td>
        <td>59</td>
    </tr>
    <tr>
    	<td>3</td>
        <td>2</td>
        <td>2</td>
        <td>100</td>
    </tr>
</table>

## 模块1

根据以上表格创建数据库&表结构 并录入数据

```mysql
drop database if exists school;
create database school default CHARACTER set utf8 collate utf8_general_ci;
use school;


create table class(
	cid int not null primary key auto_increment,
    caption varchar(16) not null
)default charset=utf8;

insert into class(caption) values ('三年二班'),('一年三班'),('三年一班');


create table student(
    sid int not null primary key auto_increment,
    sname varchar(16) not null,
    gender char(1) not null,
    class_id int not null,
    constraint fk_student_class foreign key (class_id) references class(cid)
)default charset=utf8;

insert into student(sname,gender,class_id) values ('学生1','女',1),('学生2','女',1),('学生3','男',2);


create table teacher(
    tid int not null primary key auto_increment,
    tname varchar(16) not null
)default charset=utf8;

insert into teacher(tname) values ('教师1'),('教师2'),('教师3');


create table course(
    cid int not null primary key auto_increment,
    cname varchar(32) not null,
    teacher_id int not null,
    constraint fk_course_teacher foreign key (teacher_id) references teacher(tid)
)default charset=utf8;

insert into course(cname,teacher_id) values ('生物',1),('体育',1),('地理',2);


create table score(
    sid int not null primary key auto_increment,
    student_id int not null,
    course_id int not null,
    number int not null,
    constraint fk_score_course foreign key (course_id) references course(cid),
    constraint fk_score_student foreign key (student_id) references student(sid)
)default charset=utf8;

insert into score(student_id,course_id,number) values (1,1,60),(1,2,59),(2,2,100);
```

.sql导入导出文件与上述语法稍有差别

导入命令为

```mysql
mysql -u root - p 数据库名称 < 文件夹地址
```

导出命令为

```mysql
mysqldump -u root - p 数据库名称 > 文件夹地址
```

## 模块2

### 一

创建用户kasper并赋予此数据库的所有权限

```mysql
create user 'kasper'@'%' identified by '123456';
grant all privileges on school.* to 'kasper'@'%';
flush privileges;
```

### 二

查询姓李老师的个数

```mysql
select * from teacher where tname like "李%";
```

### 三

查询姓张的学生名单

```mysql
select * from student where sname like "张%";
```

### 四

查询男生女生的人数

```mysql
select gender, count(1) from student group by gender;
```

### 五

查询同名同姓的学生名单，并统计同名人数

```mysql
select sname,count(1) from student group by sname;
select sname,count(1) from student group by sname having count(1) > 1;
```

### 六

查询三年二班的所有学生

```mysql
select * from student left join class on student.class_id = class.cid where class.caption = '三年二班';
```

### 七

查询每个班级的班级名称班级人数

```mysql
select class_id,count(1) from student group by class_id;
select class.caption,count(1) from student left join class on student.class_id = class.cid group by class.caption;
```

### 八

查询成绩小于60分的同学的学号、姓名、成绩、课程名称。

```mysql
select * from score where number < 60;

select
	student.cid,
	student.cname,
	score.number,
	course.cname
from
	score
	left join student on score.student_id = student.sid
	left join course on score.course_id = course.cid
where num < 60;
```

### 九

查询选修了生物课的所有学生ID、学生姓名、成绩。

```mysql
select * from score left join course on score.course_id = course.cid where course.cname = "生物";

select 
	student.sid,
	student.sname,
	score.number 
from 
	score 
	left join course on score.course_id = course.cid 
	left join student on score.student_id = student.sid 
where course.cname = "生物";
```

### 十

查询选修了体育课且分数低于60所有学生ID、学生姓名、成绩

```mysql
select 
	student.sid,
	student.sname,
	score.number 
from 
	score 
	left join course on score.course_id = course.cid
	left join student on score.student_id = student.sid 
where course.cname = "体育" and score.number < 60;	
```

### 十一

查询所有同学的学号、姓名、选课数、总成绩。

```mysql
select student_id,count(1),sum(number) from score group by student_id;
select 
	student_id,
	student.sname,
	count(1),
	sum(number) 
from 
	score 
	left join student on score.student_id = student.sid 
group by 
	course_id;
```

### 十二

查询各科被选修的学生数

```mysql
select course_id,count(1) from score group by course_id;
select 
	course_id,
	course.cname,
	count(1) 
from
	score 
	left join course on score.course_id = course.cid 
group by 
	course_id;
```

### 十三

查询各科成绩的总分、最高分、最低分，显示：课程ID、课程名称、总分、最高分、最低分。

```mysql
select 
    course_id,
    course.cname,
    sum(number),
    max(number),
    min(number) 
from
	score 
	left join course on score.course_id = course.cid 
group by 
	course_id;
```

### 十四

查询各科成绩的平均分，显示：课程ID、课程名称、总分、最高分、最低分。

```mysql
select 
	course_id,
	course.cname,
	sum(number),
	max(number),
	min(number) 
from 
	score 
	left join course on score.course_id = course.cid 
group by 
	course_id;
```

### 十五

查询各科成绩的平均分，显示：课程ID、课程名称、平均分。

```mysql
select 
	course_id,
	course.cname,
	avg(number) 
from 
	score 
	left join course on score.course_id = course.cid
group by 
	course_id;
```

### 十六

查询各科成绩的平均分，显示：课程ID、课程名称、平均分（按平均分从大到小排序）。

```mysql
select 
	course_id,
	course.cname,
	avg(number) 
from 
	score 
	left join course on score.course = course.cid 
group by course_id 
order by avg(number) desc;

select 
	course_id,
	course.cname,
	avg(number) as A 
from 
	score 
	left join course on score.course = course.cid 
group by 
	course_id 
order by 
	A desc;
```

### 十七

查询各科成绩平均分和及格率，显示：课程ID、课程名称、平均分、及格率。

```mysql
select 
	sid,
	course_id,
	number,
	case when score.number >= 60 then 1 else 0 end "是否及格" 
from score;
```

```mysql
select 
	course_id,
	course.cname,
	avg(number),
	count(1) as total,
	sum(case when score.number >= 60 then 1 else 0 end)
from 
	score
	left join course on score.course_id = course.cid
group by 
	course_id;
```

```mysql
select 
	course_id,
	course.cname,
	avg(number),
	sum(case when score.number >= 60 then 1 else 0 end)/count(1) *100 as pass_rate,
from 
	score
	left join course on score.course_id = course.cid
group by 
	course_id;
```

### 十八

查询平均成绩大于60 的所有学生的学号、平均成绩。

```mysql
select student_id,avg(number) from score group by studenty_id having avg(number) > 60;
```

### 十九

查询平均成绩大于85的所有学生

```mysql
select student_id,avg(number) from score group by student_id having avg(number) > 85;
select student_id,avg(number),student.sname from score left join student on score.student_id = student.sid group by student_id having avg(number) > 85;
```

### 二十

查询三年二班每个学生的学号、姓名、总成绩、平均成绩

```mysql
select 
	* 
from 
	score
	left join student on score.student_id = student.sid
	left join class on class.cid = student.class_id;
```

```mysql
select 
	* 
from 
	score
	left join student on score.student_id = student.sid
	left join class on class.cid = student.class_id;
where
	class.caption = "三年二班";
```

```mysql
select 
	student_id,
	sname,
	sum(number),
	avg(number)
from 
	score
	left join student on score.student_id = student.sid
	left join class on class.cid = student.class_id;
where
	class.caption = "三年二班"
group by 
	student_id;
```

### 二十一

查询各个班级的班级名称、总成绩、平均成绩、及格率（按照平均成绩从大到小）。

```mysql
select 
	class.cid,
	class.caption,
	sum(number),
	avg(number) as av,
	sum(case when score.number > 60 then 1 else 0 end)/count(1)*100 as pass_rate
from 
	score
	left join student on score.student_id = student.sid
	left join class on class.cid = student.class_id
group by 
	class.cid
order by
	av desc;
```

### 二十二

查询学过教师3老师课同学的学号、姓名。

```mysql
select 
	student.sid,
	student.sname 
from 
	score
	left join student on score.student_id = student.sid
	left join course on score.course_id = course.cid
	left join teacher on course.teacher_id = teacher.tid
where
	teacher.tname = "教师3"
```

### 二十三

查询没学过教师3老师课同学的学号、姓名。

```mysql
select student.sid,student.sname from student where student.sid not in(
	select 
        student.sid
    from 
        score
        left join student on score.student_id = student.sid
        left join course on score.course_id = course.cid
        left join teacher on course.teacher_id = teacher.tid
    where
        teacher.tname = "教师3"
)
```

### 二十四

查询选修教师1所授课程的学生中，成绩最高的学生姓名及成绩（不考虑并列）。

```mysql
select 
	student.sid,
	student.sname 
from 
	score
	left join student on score.student_id = student.sid
	left join course on score.course_id = course.cid
	left join teacher on course.teacher_id = teacher.tid
where
	teacher.tname = "教师1" 
order by 
	score.number desc 
	limit 1;
```

### 二十五

查询选修教师1所授课程的学生中，成绩最高的学生姓名及成绩（考虑并列）。

```mysql
select 
	student.sid,
	student.sname 
from 
	score
	left join student on score.student_id = student.sid
	left join course on score.course_id = course.cid
	left join teacher on course.teacher_id = teacher.tid
where
	teacher.tname = "教师1" 
	and score.number = (
        select 
        	max(number) 
        from 
        	score 
        	left join course on score.course_id = course.cid 
        	left join teacher on course.teacher_id = teacher.tid 
        where 
        	teacher.tname = "教师1" 
    )
```

### 二十六

查询只选修了一门课程的全部学生的学号、姓名。

```mysql
select 
	student.sid,
	student.sname 
from 
	score 
	left join student on score.student_id = student.sid 
group by 
	student_id 
having 
	count(1) = 1;
```

### 二十七

查询至少选修两门课程的学生学号、学生姓名、选修课程数量。

```mysql
select 
	student.sid,
	student.sname,
	count(1)
from 
	score 
	left join student on score.student_id = student.sid 
group by 
	student_id
having 
	count(1) >= 2;
```

### 二十八

查询两门及以上不及格的同学的同学学号、姓名、选修课程数量。

```mysql
select 
	student.sid,
	student.sname,
	count(1)
from
	score 
	left join student on score.student_id = student.sid
where 
	number < 60 
group by 
	student_id 
having 
	count(1) >= 2;
```

### 二十九

查询选修了所有课程的学生的学号、姓名。

```mysql
select 
	student.sid,
	student.sname 
from 
	score 
	left join student on score.student_id = student.sid 
group by 
	student_id
having 
	count(1) = (select count(1) from course);
```

### 三十

查询未选修所有课程学生的学号、姓名。

```mysql
select student.sid,student.sname from score where student.sid not in(
    select 
        student.sid,
        student.sname 
    from 
        score 
        left join student on score.student_id = student.sid 
    group by 
        student_id
    having 
        count(1) = (select count(1) from course)
);
```

也可以写为

```mysql
select 
	student.sid,
	student.sname 
from 
	score 
	left join student on score.student_id = student.sid 
group by 
	student_id
having 
	count(1) != (select count(1) from course);
```

### 三十一

查询所有学生都选修了的课程号、课程名。

```mysql
select 
	course.cid,
	course.cname 
from 
	score 
	left join course on score.course_id = course.cid 
group by 
	course_id 
having 
	count(1) = (select count(1) from student);
```

### 三十二

查询选修生物和体育的所有学生学号、姓名。

```mysql
select 
	student.sid,
	student.sname 
from 
	score 
	left join course on score.course_id = course.cid 
	left join student on score.student_id = student.sid 
where 
	course.cname in ("生物","体育")
group by 
	student_id;
having 
	count(1) = 2;
```

### 三十三

查询有一门课以上与学号为1的学生所选课程相同的其他学生学号和姓名。

```mysql
select 
	student.sid,
	student.sname 
from 
	score 
	left join course on score.course_id = course.cid
	left join student on score.student_id = student.sid
where 
	score.course_id in (select course_id from score where student_id = 1) 
	and score.student_id != 1 
group by 
	student_id
having
	count(1) > 1
```

### 三十四

查询与学号为1的学生所选课程完全相同的其他学生学号和姓名。

```mysql
select 
	student.sid,
	student.sname 
from 
	score
	left join course on score.course_id = course.cid
	left join student on score.student_id = student.sid
where 
	score.course_id in (select course_id from score where student_id = 1) 
	and score.student_id in (
        select
        	student_id
        from
        	score
        where 
        	student_id != 1
        group by
        	student_id 
        having
        	count(1) = select count(1) from score where student_id = 1
    )
group by 
	student_id
having
	count(1) = (select count(1) from score where student_id = 1)
```

### 三十五

查询生物课比体育课成绩高的所有学生的学号。

```mysql
select 
	student_id,
	case cname when "生物" then number else -1 end Bio
	case cname when "体育" then number else -1 end PE
from 
	score 
	left join course on score.course_id = course.cid
where 
	cname in ("生物","体育")
group by 
	student_id;
```

整理有

```mysql
select 
	student_id,
	max(case cname when "生物" then number else -1 end) as Bio
	max(case cname when "体育" then number else -1 end) as PE
from 
	score 
	left join course on score.course_id = course.cid
where 
	cname in ("生物","体育")
group by 
	student_id;
having 
	Bio > PE;
```

### 三十六

查询没门课程成绩最好前三名（不考虑并列）。

```mysql
select 
	cid,
	cname,
	(
        select 
            student.sname
        from
        	score 
        	left join student on student.sid = score.student_id
        where
        	course_id = course.cid
        order by 
        	number desc
        	limit 1 
        	offset 0
    ) as "第一名",
	(
        select 
            student.sname
        from
        	score 
        	left join student on student.sid = score.student_id
        where
        	course_id = course.cid
        order by 
        	number desc
        	limit 1 
        	offset 1
    ) as "第二名",
	(
        select 
            student.sname
        from
        	score 
        	left join student on student.sid = score.student_id
        where
        	course_id = course.cid
        order by 
        	number desc
        	limit 1 
        	offset 2
    ) as "第三名"
from
	course;
```

### 三十七

查询没门课程成绩最好前三名（考虑并列）。

```mysql
select 
	cid,
	cname,
	(
        select
        	number
        from
        	score
        where
        	course_id = course.cid 
        group by 
        	number
        order by
        	number desc
        	limit 1
        	offset 0
    ) as "最高分",
    (
        select
        	number
        from
        	score
        where
        	course_id = course.cid 
        group by 
        	number
        order by
        	number desc
        	limit 1
        	offset 1
    ) as "第二高分",
    (
        select
        	number
        from
        	score
        where
        	course_id = course.cid 
        group by 
        	number
        order by
        	number desc
        	limit 1
        	offset 2
    ) as "第三高分"
from 
	course;
```

所以有

```mysql
select 
	*
from
	score
	left join (
        select 
            cid,
            cname,
            (
                select
                    number
                from
                    score
                where
                    course_id = course.cid 
                group by 
                    number
                order by
                    number desc
                    limit 1
                    offset 0
            ) as Top1,
            (
                select
                    number
                from
                    score
                where
                    course_id = course.cid 
                group by 
                    number
                order by
                    number desc
                    limit 1
                    offset 1
            ) as Top2,
            (
                select
                    number
                from
                    score
                where
                    course_id = course.cid 
                group by 
                    number
                order by
                    number desc
                    limit 1
                    offset 2
            ) as Top3
        from 
            course
    ) as C on score.course_id = C.cid
where
	score.number >= C.Top3;
```

### 三十八

创建一个表sc，将score中所有数据插入sc表中

```mysql
create table sc(
    sid int not null primary key auto_increment,
    student_id int not null,
    course_id int not null,
    number int not null,
    constraint fk_score_course foreign key (course_id) references course(cid),
    constraint fk_score_student foreign key (student_id) references student(sid)
)default charset=utf8;
```

```mysql
insert into sc select * from score;
```

### 三十九

向sc表中插入一些记录，这些记录需符合：

- 学生ID为：没上过课程ID为2的学生学号

- 课程ID为：2
- 成绩为：80

```mysql
insert into sc(student_id,course_id,number) select sid,2,80 from student where sid not in (select student_id from score where course_id = 2);
```

### 四十

向sc表中插入一些记录，这些记录需符合：

- 学生ID为：没上过课程ID为2的学生学号

- 课程ID为：2
- 成绩为：课程ID为3的最高分

```mysql
insert into sc(student_id,course_id,number) select sid,2,(select max(number) from score where course_id = 3) as number from student where sid not in (select student_id from score where course_id = 2);
```

# 索引

- mysiam引擎，非聚簇索引（数据和索引结构分开存储）
- innodb引擎，聚簇索引（数据和逐渐结构存储在一起）（常用，推荐）

常见索引类型有：

- 主键索引：加速查找、不能为空、不能重复。+联合主键索引
- 唯一索引：加速查找、不能重复。+联合唯一索引
- 普通索引：加速查找。+联合索引

## 常见索引

### 主键和联合主键索引

```mysql
create table 表名(
    id int not null auto_increment primary key,
    name varchar(32) not null
);

create table 表名(
    id int not null auto_increment,
    name varchar(32) not null,
    primary key(id)
);

create table 表名(
    id int not null auto_increment,
    name varchar(32) not null,
    primary key(列1,列2)									--联合主键
);
```

增删主键操作

```mysql
alter table 表名 add primary key(列名);
alter table 表名 drop primary key;
```

有时候删除索引报错1075（42000），此错误由自增导致，需先去除自增特性

```mysql
alter table 表 change id id int not null;
```

### 唯一和联合唯一索引

```mysql
create table 表名(
    id int nut null auto_increment primary key,
    name varchar(32) not null,
    email varchar(64) not null,
    unique ix_name(name)
    unique ix_email(email)
);

create table 表名(
    id int nut null auto_increment primary key,
    name varchar(32) not null,
    email varchar(64) not null,
    unique (列1,列2)
);
```

```mysql
create unique index 索引名 on 表名(列名);
drop unique index 索引名 on 表名;
```

### 索引和联合索引

```mysql
create table 表名(
    id int nut null auto_increment primary key,
    name varchar(32) not null,
    email varchar(64) not null,
    index ix_name(name)
    index ix_email(email)
);

create table 表名(
    id int nut null auto_increment primary key,
    name varchar(32) not null,
    email varchar(64) not null,
    index (列1,列2)
);
```

```mysql
create index 索引名 on 表名(列名);
drop index 索引名 on 表名;
```

## 查询举例

<table>
    <tr>
	    <th colspan="5">student</th>
	</tr >
    <tr>
    	<td>id</td>
        <td>username</td>
        <td>password</td>
        <td>email</td>
        <td>age</td>
    </tr>
    <tr>
    	<td>1</td>
        <td>user1</td>
        <td>123456</td>
        <td>123456@gmail.com</td>
        <td>20</td>
    </tr>
     <tr>
    	<td>2</td>
        <td>user2</td>
        <td>1234567</td>
        <td>1234567@gmail.com</td>
        <td>25</td>
    </tr>
</table>

```mysql
create table big(
    id int(11) not null auto_increment,
    name varchar(32) default null,
    email varchar(64) default null,
    pwd varchar(64) default null,
    age int(11) default null,
    primary key(id),
    unique key big_unique_email(email),
    index ix_name_pwd(name,pwd)
) engine=innodb default charset=utf8;
```

一般情况我们可以通过索引搜索命中索引：

```mysql
select * from big where id = 1;
select * from big where id > 1;
select * from big where email= "123456@gmail.com";
select * from big where name= "user1";
select * from big where name= "user1" and pwd = "123456";
```

## 无法命中索引

特殊情况下无法命中索引

### 类型不一致

```mysql
select * from big where name= 123;			-- 未命中
select * from big where name= 123;			-- 未命中

-- 特殊的主键：
select * from big where id = "1";			-- 命中
```

### 使用了不等于

```mysql
select * from big where name != "user1";				-- 未命中
select * from big where email != "123456@gmail.com" ;	-- 未命中

-- 特殊的主键
select * from big where id != 123						-- 命中
```

### or

当or条件中有为建立索引的列才失效

```mysql
select * from big where id = 123 or pwd = "xx";			-- 未命中
select * from big where name = "user1" or pwd = "xx"	-- 未命中

-- 特殊的主键
select * from big where id = 1 or pwd = "xxx" and name = "user1"	-- 命中
```

### 排序

选择的映射不是索引则不走索引

```mysql
select * from big order by name asc;		-- 未命中
select * from big order by name desc;		-- 未命中

select name from big order by name asc;		-- 命中
select name from big order by name desc;	-- 命中

-- 特殊的主键
select * from big order by desc;			-- 命中
```

### like 

模糊匹配时

```mysql
select * from big where name like "%ser1";	-- 未命中
select * from big where name like "_ser1";	-- 未命中
select * from big where name like "us%r1";	-- 未命中

-- 特殊的
select * from big where name like "us%";	-- 命中
select * from big where name like "user%";	-- 命中
```

### 使用函数

```mysql
select * from big where fun1(name) = "user1"	-- 未命中

-- 特殊的
select * from big where name = fun1("user1")	-- 命中
```

### 最左前缀

如果是联合索引，遵循最左前缀原则。

```mysql
-- 联合索引为: (name,pwd)
name and pwd	-- 命中
name			-- 命中
pwd				-- 未命中
name or pwd		-- 未命中
```

## 执行计划

MySQL中提供执行计划以供预判SQL执行（仅供参考）

```mysql
explain + SQL语句
```

其中比较重要的是type，其为SQL性能标志，性能从高到低为

```mysql
ALL < INDEX < RANGE < INDEX_MERGE < REF_OR_NULL < REF < EQ_REF < SYSTEM/CONST
```

- ALL，全表扫描
- INDEX，全索引扫描
- RANGE，对索引列进行范围查找
- INDEX_MERGE，合并索引
- REF_OR_NULL
- REF，根据索引直接查找（非键）
- EQ_REF，连表操时按索引查
- CONST，常量，表最多有一个匹配行，因此这行可被优化器优化到常数
- SYSTEM，系统，表仅有一行（=系统表），CONST的特例

# 函数

[函数参考](https://dev.mysql.com/doc/refman/5.7/en/functions.html )

自定义函数：

创建函数

```mysql
delimiter $$
create function f1(
    i1 int,
    i2 int
)
return int
begin
	declare num int;
	declare maxID int;
	select max(id) from big into maxID;
	set num = i1 + i2 + maxID;
	return(num);
end $$
delimiter;
```

执行函数

```mysql
select f1(11,id),name from d1;
```

删除函数

```mysql
drop function f1;
```

# 存储过程

- 创建存储过程

``` mysql
delimiter $$
create procedure p1()
begin
	select * from usersdb;
end $$
delimiter ;
```

- 执行存储

``` mysql
call p1();
```

```python
import pymysql

conn = mymysql.connect(host='127.0.0.1',port=3306,user='root',password='123456',db='usersdb')
cursor = conn.cursor(cursor=pymysql.cursors.DictCursor)

# 执行存储过程
cursor.callproc('p1')
result = cursor.fetchall()

cursor.close()
conn.close()

print(result)
```

- 删除存储过程

```mysql
drop procedure proc_name;
```

## 参数类型

存储过程有以下三种：

- in，仅用于传入参数
- out，仅用于返回值用
- inout，即可以传入也可以当作返回值

```mysql
delimiter $$
create procedure p2(
    in i1 int,
    in i2 int,
    inout i3 int,
    out r1 int
)
begin
	DECLARE temp1 int;
	DECLARE temp2 int default 0;
	
	set temp1 = 1;
	
	set r1 = i1 + i2 + temp1 + temp2;
	
	set i3 = i3 + 100
	
end $$
delimiter ;
```

```mysql
set @t1 = 4;
set @t2 = 0;
call p2(1,2,@t1,@t2);
select @t1,@t2;
```

```python
import pymysql

conn = pymysql.connect(host='127.0.0.1', port=3306, user='root', password='123456', db='usersdb')
cursor = conn.cursor(cursor=pymysql.cursors.DictCursor)

# 执行存储过程
cursor.callproc('p2',args=(1, 22, 3, 4))

# 获取执行完存储的参数
cursor.execute("select @_p2_0,@_p2_1,@_p2_2,@_p2_3")
result = cursor.fetchall()

cursor.close()
conn.close()

print(result)
```

## 返回值&结果集

```mysql
delimiter $$
create procedure p3(
    in n1 int,
    inout n2 int,
    out n3 int
)
begin
	set n2 = n1 + 100;
	set n3 = n2 + n1 + 100;
	select * from usersdb;
end $$
delimiter ;
```

```mysql
set @t1 = 4;
set @t2 = 0;
call p3(1,@t1,@t2);
select @t1,@t2;
```

```python
import pymysql

conn = pymysql.connect(host='127.0.0.1', port=3306, user='root',password='123456', db='usersdb')
cursor = conn.cursor(cursor=pymysql.cursors.DictCursor)

# 执行存储过程
cursor.callproc('p3',args=(22, 3, 4))
table = cursor.fetchall()

# 获取执行完存储的参数
cursor.execute("select @_p3_0,@_p3_1,@_p3_2")
rets = cursor.fetchall()

cursor.close()
conn.close()
```

## 事务&异常

事务：成功都成功，失败都失败。

```mysql
delimiter $$
create procedure p4(
    out p_return_code tinyint
)
begin
	declare exit handler for sqlexception
	begin
		-- ERROR
		set p_return_code = 1;
		rollback;
	end;
	
	declare exit handler for sqlwarning
	begin
		-- WARNING
		set p_return_code = 2;
		rollback;
	end;
	
	start transaction;
		delete from usersdb;
		insert into tb(name)values('seven');
	commit;
	
	-- SUCCESS
	set p_return_code = 0;
	
	end $$
delimiter ;
```

```mysql
set @ret = 100;
call p4(@ret);
select @ret;
```

```python
import pymysql

conn = pymysql.connect(host='127.0.0.1',port=3306,user='root',password='123456', db='usersdb')
cursor = conn.cursor(cursor=pymysql.cursors.DictCursor)

# 执行存储过程
cursor.callproc('p4',args=(100))

# 获取执行完存储的参数
cursor.execute("select @_p4_0")
rets = cursor.fetchall()

cursor.close()
conn.close()
```

## 游标

```mysql
delimiter $$
create procedure p5()
begin
	declare sid int;
	declare sname varchar(50);
	declare done int default false;
	
	declare my_cursor cursor for select id,name from usersdb;
	
	declare continue handler for not found set done = true;
	
	open my_cursor;
		xxoo: loop
			fetch my_cursor into sid,sname;
			if done then
				leave xxoo;
			end if;
			insert into t1(name) values(sname)
		end loop xxoo;
	close my_cursor;
end $$
delimiter ;
```

```mysql
call p5();
```

## 视图

视图是一个虚拟表，为了方便使用而设置，如下：

```mysql
select 
	*
from 
	(select id,name from users where id >= 1) as A
where 
	A.name = '123'
```

如需简化from后的语句，则可以使用视图

### 创建视图

```mysql
create view v1 as select id,name from users where id >= 1
```

### 使用视图

```mysql
select * from v1;
```

### 删除视图

```mysql
drop view v1;
```

### 修改视图

```mysql
alter view v1 as SQL语句
```

注意：基于视图只能查询，针对视图不能执行增加、修改、删除。如果源表发生变化，视图表也发生变化

## 触发器

对某个表进行增/删/改操作的前后如果希望触发某个特定行为时，可以使用触发器。

```mysql
# 插入前
create trigger tri_before_insert_tb1 before insert on tb1 for each row
begin
	...
end

# 插入后
create trigger tri_before_insert_tb1 after insert on tb1 for each row
begin
	...
end

# 删除前
create trigger tri_before_delete_tb1 before delete on tb1 for each row
begin
	...
end

# 删除后
create trigger tri_before_delete_tb1 after delete on tb1 for each row
begin
	...
end

# 更新前
create trigger tri_before_update_tb1 before update on tb1 for each row
begin
	...
end

# 更新后
create trigger tri_before_update_tb1 after update on tb1 for each row
begin
	...
end
```

```mysql
drop trigger tri_after_insert_tb1;
```

示例：

在t1表中插入数据之前，先在t2表中插入一行数据。

```mysql
delimiter $$
create trigger tri_before_insert_t1 before insert on t1 for each row
begin
	-- NEW.id	NEW.name	NEW.email
	-- INSERT INTO t2(name) VALUES();
	if NEW.name = 'user1' then
		insert into t2(name) values(NEW.id);
	end if;
end $$
delimiter ;
```

在t1表中删除数据之后，在t2表中插入一行数据。

```mysql
delimiter $$
create trigger tri_after_insert_t1 after delete on t1 for each row
begin
	if OLD.name = 'user1' then
		insert into t2(name) values(OLD.id);
	end if;
end $$
delimiter ;
```

其中OLD表示原来的数据，NEW表示新数据。

# 事务

innodb支持事务，mysiam不支持事务。事务有四个特性：

- 原子性(Atomicity)：指事务包含所有操作不可分割，要成功都成功要失败都失败。
- 一致性(Consistency)：执行前后的数据完整性保持一致。
- 隔离性(Isolation)：一个事务执行过程中，不应受到其他食物的干扰。
- 持久性(Durability)：shiwu一旦结束，数据就持久地保存在数据库中。

示例：

<table>
    <tr>
	    <th colspan="3">L1</th>
	</tr >
    <tr>
    	<td>id</td>
        <td>name</td>
        <td>account</td>
    </tr>
    <tr>
    	<td>1</td>
        <td>user1</td>
        <td>300</td>
    </tr>
    <tr>
    	<td>2</td>
        <td>user2</td>
        <td>800</td>
    </tr>
</table>

```mysql
create table L1(
    id int(11) not null auto_increment,
    name varchar(255) default null,
    count int(11) default null,
    primary key(id)
) engine=innodb default charset=utf8;
```

## MySQL终端

```mysql
begin;												-- 开始事务
update users set amount = amount+200 where id = 1;	-- 执行操作
update users set amount = amount-200 where id = 2;	-- 执行操作
commit;												-- 提交事务
-- rollback;										-- 返回初始数据
```

```python
import pymysql

conn = pymysql.connect(host='127.0.0.1', port=3306, user='root', password='123456', charset='utf8', db='usersdb')
cursor = conn.cursor()

# 开启事务
conn.begin()

try:
    cursor.execute("update users set amount = amount+200 where id = 1")
    int('asdf')
    cursor.execute("update users set amount = amount-200 where id = 2")
except Exception as e:
    # 回滚
    print("回滚")
    conn.rollback()
else:
    # 提交
    print("提交")
    conn.commit()

cursor.close()
conn.close()
```

# 锁

- 表级锁：即A操作表时，其他人对整个表都不能操作，等A操作完后，其他人方可操作。
- 行级锁：即A操作表时，其他人对指定行的数据不可操作，其他行可以操作，等A操作完后，其他人方可对指定行进行操作

特别地

- mysiam支持表锁，不支持行锁。
- innodb支持行锁和表锁。

<table>
    <tr>
	    <th colspan="3">L1</th>
	</tr >
    <tr>
    	<td>id</td>
        <td>name</td>
        <td>account</td>
    </tr>
    <tr>
    	<td>1</td>
        <td>user1</td>
        <td>300</td>
    </tr>
    <tr>
    	<td>2</td>
        <td>user2</td>
        <td>800</td>
    </tr>
</table>

```mysql
create table L1(
    id int(11) not null auto_increment,
    name varchar(255) default null,
    count int(11) default null,
    primary key(id)
) engine=innodb default charset=utf8;
```

在innodb引擎中，update、insert、delete等操作，内部枷锁会排队逐一执行。

select中默认不会申请锁。如果有需要给select加锁，需要事务+特殊语法来实现。

## for update,

排他锁，加锁以后，其他不可以读写

```mysql
begin;
	select * from L1 where name="user1" for update;		-- name列不是索引
commit;
```

```mysql
begin;	-- 或者start transaction
	select * from L1 where id = 1 for update;			-- id列是索引（行锁）
commit
```

## lock in share model

共享锁，加锁后可读不可写。

```mysql
begin;
	select * from L1 where name = "user1" lock in share mode;	-- name列不是索引
commit;
```

```mysql
begin;	-- 或者start transaction
	select * from L1 where id = 1 lock in share mode;			-- id列是索引（行锁）
commit
```

# 数据库连接池

python中相关包安装：

```python
pip install pymysql
pip install dbutils
```

相关举例见同目录下的py文件

# SQL工具类

## 单例和方法

## 上下文管理
